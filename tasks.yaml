tasks:
  - name: uds-up
    description: Brings up uds-slim-dev
    actions:
      - cmd: cp test/zarf-config-dev.yaml ./zarf-config.yaml
      - cmd: cd test && uds deploy k3d-core-slim-dev:0.22.2 -c
  - name: registry-up
    description: Creates a local docker registry for local package pushing to zarf
    actions:
      - cmd: docker run -d -p 5000:5000 --restart=always --name registry registry:2
  - name: registry-down
    description: Kills the local docker registry
    actions:
      - cmd: docker kill registry
      - cmd: docker rm registry
  - name: recycle-registry
    description: recycles the registry for recreating images
    actions:
      - task: registry-down
      - cmd: sleep 2
      - task: registry-up
  - name: build-image
    description: pushes the test image to the local registry
    actions:
      - cmd: docker build -t localhost:5000/legit-workflow:latest ./test/workflows/
      - cmd: docker push localhost:5000/legit-workflow:latest
  - name: build-package
    description: Builds the zarf package to deploy vanilla argo workflows
    actions:
      - cmd: zarf package create --skip-sbom --confirm --flavor vanilla
  - name: deploy-package
    description: Deploys the zarf package
    actions:
      - cmd: |
          zarf -l debug --no-log-file package deploy \
          zarf-package-argo-workflows-amd64.tar.zst --confirm
  - name: deploy-template
    description: Deploys a hello-world WorkflowTemplateRef to test functionality
    actions:
      - cmd: kubectl apply -f test/workflows/hello-world-template.yaml
  - name: submit-workflow
    description: Submits a test workflow with the hello-world template
    actions:
      - cmd: argo submit -n argo test/workflows/hello-world.yaml
  - name: remove-package
    description: uninstalls the zarf package
    actions:
      - cmd: zarf package remove zarf-package-argo-workflows-amd64.tar.zst --confirm
      - cmd: kubectl delete namespace argo
      - cmd: rm zarf-package-argo-*.tar.zst
  - name: remove-uds
    description: Uninstalls uds-slim-dev and the k3d cluster
    actions:
      - cmd: uds remove k3d-core-slim-dev:0.22.2 -c
      - cmd: k3d cluster delete uds
      - cmd: docker kill registry
  - name: workflows-up
    description: brings up everything from scratch (uds-slim-dev included)
    actions:
      - task: uds-up
      - task: build-image
      - task: build-package
      - task: deploy-package
  - name: recycle-workflows
    description: removes the zarf package for argo, rebuilds it, then deploys it
    actions:
      - task: remove-package
      - task: build-package
      - task: deploy-package
  - name: test-workflows
    description: Submits a test workflow
    actions:
      - task: deploy-template
      - task: submit-workflow
  - name: cleanup
    description: Cleans up the deployment / cluster
    actions:
      - task: remove-package
      - cmd: rm zarf-config.yaml
      - task: remove-uds
